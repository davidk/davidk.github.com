<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Timelapse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <link href="http://open.konspyre.org/categories/timelapse/index.xml" rel="alternate" type="application/rss+xml" title="open collector" />
  <link href="http://open.konspyre.org//css/bootstrap.min.css" rel="stylesheet">
  <link href="http://open.konspyre.org//css/hc.css" rel="stylesheet">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  
    
    </head>
    <body>
<div class="nav-toggle"><i class="fa fa-bars fa-2x"></i> Herring Cove </div>
      <div id = "wrapper">


<div class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="http://open.konspyre.org//"><h1 class="brand">open collector</h1></a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
          
            <li><a href="/archives/">Archives</a></li>
          
            <li><a href="/categories/">Categories</a></li>
          
          <hr />
          
            <li><a href="/pages/about/">About</a></li>
          
					
					
          </ul>
        </div>
      </div>
    </div>



       
       <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
					<img src="" />
          <li class="sidebar-brand"><a href="http://open.konspyre.org//"><h1 class="brand">open collector</h1></a><h3></h3></li>
          <hr />
          
            <li><a href="/archives/">Archives</a></li>
          
            <li><a href="/categories/">Categories</a></li>
          
          <hr />
          
            <li><a href="/pages/about/">About</a></li>
          
					
          <hr />
          <div id="social-wrapper">
           <li> <a href="https://twitter.com/bytctr"><i class="fa fa-twitter-square"></i> @twitter</a></li>
           
           
           <li> <a href="https://github.com/davidk/"><i class="fa fa-github-square"></i> github</a> </li>
         </div>
       </ul>
     </div>



     <div class="container">

<div id="article">
  
  <div class="article-title"><a href="http://open.konspyre.org/blog/2013/05/13/stop-blink-and-roll/">Stop, blink and roll*</a></div>
  <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i>On 2013-05-13 and filed under:
    
    <a href="/categories/timelapse">timelapse</a>
    
    <a href="/categories/attiny">attiny</a>
    
    <a href="/categories/buspirate">buspirate</a>
    
    <a href="/categories/contest">contest</a>
    
    <a href="/categories/bb313">bb313</a>
    
    <a href="/categories/buspirate3">buspirate3</a>
    
  </small></p><hr/>
  <div class="post">
    

<p>A little bit of the cat got out of the bag some time ago:</p>

<p><img src="/assets/images/avrrrinator/6-seconds-avrrrinator.gif" alt="6 seconds of AVR flashing" />
</p>

<p>You&rsquo;re looking at ~24 hours of continuous AVR flashing compressed down into 6 seconds.</p>

<p>While I won&rsquo;t be releasing the connecting PCB just yet (i&rsquo;m still beating down a few issues and refining the BOM), I thought it would be good to supply the scripts I used to do the actual time lapse since it was non-obvious from a &ldquo;oh dear, the contest entry is due in &lt;48 hours isn&rsquo;t it..&rdquo; point of view.</p>

<h2 id="parts-and-materials:c434917f357788de682d8fe989da3bc9">Parts and Materials</h2>

<ul>
<li><p><strong>Teensy3</strong>:  Attached to the system doing the programming</p></li>

<li><p><strong>SSD1306</strong>: OLED display showing how many times the AVR has been programmed</p></li>

<li><p><strong>Bus Pirate 3</strong>: Acting as an AVR programmer</p></li>

<li><p><strong>Avrrrinator Rev B</strong>: Bus Pirate to 2x AVR ISP adapter (this is the super secret &ldquo;prototype&rdquo; I mentioned in the <a href="http://www.youtube.com/watch?v=1nvUlqp4ISU">YouTube post</a>)</p></li>

<li><p><strong>BB313 boards</strong>: Breakouts for easily attaching AVR ISP cables</p></li>

<li><p><strong>ATtiny4313</strong>: tiny AVR for programming</p></li>

<li><p><strong>ATtiny85</strong>: tiny AVR for programming</p></li>

<li><p><strong>Assorted LEDs</strong>: Status indicators/Lighting</p></li>

<li><p><strong>Logitech C920 Webcam</strong>: Takes all the pictures</p></li>
</ul>

<h2 id="taking-a-picture:c434917f357788de682d8fe989da3bc9">Taking a picture</h2>

<p>The small bash script invoking the gstreamer toolchain (without reading the documentation this is pretty much magic) took on the duty of taking a picture every minute. It then copied everything out via rsync to another machine with tons of spare space.</p>

<p>This is not properly done since my start time edged uncomfortably close to when I had to stop, edit and ship (24 hours later).</p>

<p>Note that this constantly writes over the same file. It stops the local disk from being clogged up by continuous snapshots. It also does not check and do anything reasonable if the rsync transfer fails.. like move the file aside/retry.</p>

<p>In my case, losing a few minutes worth of snapshots wasn&rsquo;t a big deal for 24 hours compressed down to 6 seconds. I actually deleted quite a few frames before rendering out to video to eliminate periods of darkness (they show up as jarring sub-millisecond transitions to darkness).</p>

<pre><code class="language-bash">#!/bin/bash

while true; do
gst-launch -e v4l2src ! video/x-raw-yuv,format=\(fourcc\)YUY2,width=1920,height=1080,framerate=5/1 \
! ffmpegcolorspace ! pngenc snapshot=true ! filesink location=&quot;frame.png&quot;

# Yup, this is talking to an actual rsyncd daemon on a NAS
RSYNC_PASSWORD=&quot;super_secret&quot; rsync -avP frame.png rsync://rsync@storage.somewhere/frame-`date '+%s'`.png

sleep 60;
done
</code></pre>

<h2 id="video-out:c434917f357788de682d8fe989da3bc9">Video out</h2>

<p>After all the frames were assembled, I manually went in and pruned a bunch that were completely dark due to the lights being off. Compressing the video down a bunch to 6 seconds took a bit of playing around, mostly with the framerate:</p>

<pre><code class="language-bash">mencoder 'mf://*.png' -mf fps=145:type=png -ovc lavc -lavcopts vcodec=mpeg4:mbd=2:trell -oac copy -o ~/Desktop/output-yt.avi
</code></pre>

<p>At this point, the video quality kind of sucked, but I had to ship it.</p>

<p>Here is the completed video:</p>

<iframe width="560" height="315" src="http://www.youtube.com/embed/1nvUlqp4ISU" frameborder="0" allowfullscreen></iframe>

<h2 id="code-doing-the-programming:c434917f357788de682d8fe989da3bc9">Code doing the programming</h2>

<p>This is the script that refreshes the display you see. It calls <code>avrdude</code> to flash the AVRs and records the return code.</p>

<p>If it is zero, then the success counter for the AVR is incremented.</p>

<p>From there counts are then written to the serial port where the Teensy 3 can handle persisting the display and refreshing it with new results.</p>

<pre><code class="language-python">#!/usr/bin/env python
# requires pyserial (pip install pyserial)
import subprocess
import serial

counter_4313 = 0
counter_85 = 0

failures_4313 = 0
failures_85 = 0

ser_port = serial.Serial(port='/dev/tty.usbmodem12341', baudrate=9600)

while True:
    try:
        ret_4313 = subprocess.check_call(['avrdude', '-v', '-p', 'attiny4313', '-c', 'buspirate', '-P',
        '/dev/tty.usbserial-AE01J4Q7', '-U', 'flash:w:blinky313.hex', '-x', 'reset=aux'])
    except subprocess.CalledProcessError:
        ret_4313 = 1

    if ret_4313 == 0:
        print &quot;ATtiny4313&quot;
        counter_4313 += 1
    else:
        failures_4313 += 1

   # Report statistics to the LCD screen
    report = &quot;313:%s\n\n85:%s&quot; % (counter_4313, counter_85)
    ser_port.write(report)
    try:
        ret_85 = subprocess.check_call(['avrdude', '-v', '-p', 'attiny85', '-c', 'buspirate', '-P',
        '/dev/tty.usbserial-AE01J4Q7', '-U', 'flash:w:blinky45.hex', '-x', 'reset=cs'])
    except subprocess.CalledProcessError:
        ret_85 = 1

    if ret_85 == 0:
        print &quot;ATtiny85&quot;
        counter_85 += 1
    else:
        failures_85 += 1

   # We do this twice to make it look more live
    report = &quot;313:%s\n\n85:%s&quot; % (counter_4313, counter_85)
    ser_port.write(report)
</code></pre>

<p>On the Teensy 3, the data is received and pumped out to the display. Not the greatest code, but decent enough to run for 24 hours without much of a hiccup.</p>

<p>Note that there are several small issues when using the SSD1306 library with the Teensy 3. I just stomped out the relevant sections after chasing down errors from the compiler (which were unrelated to SPI operation, and mostly due to i2c support).</p>

<pre><code class="language-arduino">/*********************************************************************
* Flash Counter!
* Teensy 3.0 attached to a 128x64 SPI-driven OLED display
* Vendor: Adafruit
*
* IF YOU GET COMPILE ERRORS (you likely will!)
* Stomp out the compile errors in Adafruit_SSD1306.cpp line by line
* and everything should be OK (most of them are i2c related).
*
*********************************************************************/
#include &lt;Wire.h&gt;
#include &lt;Adafruit_GFX.h&gt;
#include &lt;Adafruit_SSD1306.h&gt;

#define OLED_DC 11      // All pin numbers correspond to
#define OLED_CS 10  // the 'gray' labels on the welcome to
#define OLED_CLK 14     // Teensy 3 card
#define OLED_MOSI 12    // SSD1306 labels this as: &quot;Data&quot;
#define OLED_RESET 9

Adafruit_SSD1306 display(OLED_MOSI, OLED_CLK, OLED_DC, OLED_RESET, OLED_CS);

void setup() {
  Serial.begin(9600);
  pinMode(13, OUTPUT);

  // Display setup
  display.begin(SSD1306_SWITCHCAPVCC);
  display.clearDisplay();
  display.setTextColor(WHITE,BLACK);

}

void loop() {

  // Persist the display until we have something to display
  if( Serial.available() &gt; 0 ) {
    display.clearDisplay();
  }
  display.println(&quot;AVR Program Count&quot;);
  display.println();
  display.setTextSize(2);
  while ( Serial.available() &gt; 0 ) {
    digitalWrite(13, HIGH);
    char c = Serial.read();

    if (c == '\n') {
      display.println();
    } else {
      display.write(c);
    }
    digitalWrite(13, LOW);
  }
  display.display();

  delay(500);
  display.setTextSize(1);
  display.setCursor(0,0);
}

</code></pre>

<p>And of course, blink programs. The ATtiny4313 and <a href="https://gist.github.com/davidk/4555334">ATtiny85</a> each had their own. They&rsquo;re pretty generic, (the one for the 4313 is from the BB313 website).</p>

<p>cheers (and drink, if thats your thing)</p>

  </div>
  
  
    
</div>
    <footer>
      <p class="text-muted credit">eh?</p>
    </footer>
 
    <script src="http://open.konspyre.org//js/jquery-1.10.2.min.js"></script>
    <script src="http://open.konspyre.org//js/bootstrap.min.js"></script>
    <script src="http://open.konspyre.org//js/bootstrap.js"></script>
    <script type="text/javascript" src="http://open.konspyre.org//js/hc.js"></script>
  
  <script src="http://open.konspyre.org//highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</body>

</html>

